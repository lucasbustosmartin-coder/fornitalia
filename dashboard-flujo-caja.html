<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flujo de caja ‚Äì Fornitalia</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin: 0; padding: 0; background: #f5f5f5; display: flex; min-height: 100vh; }
    .sidebar { width: 56px; min-width: 56px; background: #1a1a1a; color: #fff; transition: width 0.25s ease; overflow: hidden; display: flex; flex-direction: column; flex-shrink: 0; }
    .sidebar.expanded { width: 220px; }
    .sidebar-toggle { display: flex; align-items: center; justify-content: center; width: 56px; height: 52px; border: none; background: transparent; color: #fff; cursor: pointer; font-size: 1.25rem; flex-shrink: 0; }
    .sidebar-toggle:hover { background: rgba(255,255,255,0.1); }
    .sidebar-toggle .icon-collapse { display: none; }
    .sidebar.expanded .sidebar-toggle .icon-expand { display: none; }
    .sidebar.expanded .sidebar-toggle .icon-collapse { display: inline; }
    .sidebar-nav { padding: 0.5rem 0; }
    .sidebar-nav .menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.65rem 1rem; color: rgba(255,255,255,0.9); text-decoration: none; border: none; background: none; width: 100%; cursor: pointer; font-size: 0.95rem; font-family: inherit; text-align: left; }
    .sidebar-nav .menu-item:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .sidebar-nav .menu-item .menu-icon { width: 24px; height: 24px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .sidebar-nav .menu-item .menu-label { white-space: nowrap; opacity: 0; width: 0; overflow: hidden; transition: opacity 0.2s, width 0.2s; }
    .sidebar.expanded .sidebar-nav .menu-item .menu-label { opacity: 1; width: auto; }
    .main-content { flex: 1; padding: 1.5rem; overflow-x: auto; }
    h1 { margin-top: 0; color: #1a1a1a; }
    .card { background: #fff; border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: right; padding: 0.5rem 0.75rem; border-bottom: 1px solid #eee; }
    th { text-align: right; font-weight: 600; color: #555; }
    td:first-child, th:first-child { text-align: left; }
    .ingresos { color: #0d7d3d; }
    .egresos { color: #b91c1c; }
    .balance { font-weight: 600; }
    .balance.positivo { color: #0d7d3d; }
    .balance.negativo { color: #b91c1c; }
    .loading { color: #666; }
    .error { color: #b91c1c; }
    .resumen { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .resumen .card { flex: 1; min-width: 140px; }
    .resumen .valor { font-size: 1.5rem; font-weight: 700; }
    .filtros { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .filtros label { display: flex; align-items: center; gap: 0.5rem; }
    .filtros select { padding: 0.4rem 0.6rem; border-radius: 6px; border: 1px solid #ccc; }
    .toggle-moneda { display: inline-flex; border-radius: 8px; border: 1px solid #ccc; overflow: hidden; background: #eee; }
    .toggle-moneda button { padding: 0.5rem 1rem; border: none; background: transparent; cursor: pointer; font-size: 1rem; }
    .toggle-moneda button.activo { background: #1a1a1a; color: #fff; font-weight: 600; }
    .tabs { display: flex; gap: 0.25rem; margin-bottom: 0.5rem; }
    .tabs button { padding: 0.5rem 1rem; border: 1px solid #ccc; background: #fff; border-radius: 6px; cursor: pointer; }
    .tabs button.activo { background: #1a1a1a; color: #fff; border-color: #1a1a1a; }
    .panel { display: none; }
    .panel.activo { display: block; }
    .sin-cotizacion-note { color: #b45309; font-size: 0.9rem; margin-top: 0.5rem; }
    .errores-panel-toolbar { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.75rem; }
    .errores-filtros { display: flex; align-items: center; gap: 0.5rem; }
    .errores-filtros label { font-size: 0.9rem; color: #555; white-space: nowrap; }
    .errores-filtros select { padding: 0.35rem 0.6rem; border-radius: 6px; border: 1px solid #ccc; font-size: 0.9rem; min-width: 200px; }
    .evolucion-table-wrap { overflow-x: auto; margin-top: 0.5rem; }
    #tabla-evolucion { min-width: 100%; }
    #tabla-evolucion th, #tabla-evolucion td { padding: 0.45rem 0.65rem; white-space: nowrap; }
    #tabla-evolucion th { background: #f2f3f5; font-weight: 600; color: #555; }
    #tabla-evolucion td.num-evolucion { text-align: right; white-space: nowrap; }
    #tabla-evolucion td.num-evolucion.evolucion-clickable { cursor: pointer; }
    #tabla-evolucion td.num-evolucion.evolucion-clickable:hover { text-decoration: underline; }
    tr.fila-mes { cursor: pointer; }
    tr.fila-mes:hover { background: #f8f8f8; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
    .modal-backdrop.oculto { display: none; }
    .modal { background: #fff; border-radius: 12px; max-width: 640px; width: 100%; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.2); }
    #modal-caja { max-width: 920px; }
    .modal-header { padding: 1rem 1.25rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: move; user-select: none; }
    .modal-header .modal-close { cursor: pointer; }
    .modal-header h2 { margin: 0; font-size: 1.25rem; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; line-height: 1; padding: 0 0.25rem; }
    .modal-body { padding: 1rem 1.25rem; overflow-y: auto; }
    .modal-body .modal-tabs { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; }
    .modal-body .modal-tabs button { padding: 0.5rem 1rem; border: 1px solid #ccc; background: #fff; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .modal-body .modal-tabs button.activo { background: #1a1a1a; color: #fff; border-color: #1a1a1a; }
    .modal-body .modal-panel { display: none; }
    .modal-body .modal-panel.activo { display: block; }
    .modal-tabla { margin-top: 0.5rem; }
    .modal-tabla th, .modal-tabla td { padding: 0.5rem 0.75rem; }
    .modal-tabla .ver-btn, .modal-tabla .grafico-btn { background: none; border: none; cursor: pointer; color: #444; padding: 0.35rem; display: inline-flex; align-items: center; justify-content: center; margin-left: 0.25rem; }
    .modal-tabla .ver-btn:hover, .modal-tabla .grafico-btn:hover { color: #1a1a1a; }
    .modal-tabla tr.detalle-cat td { background: #f8f9fa; padding-left: 1.5rem; vertical-align: top; }
    .modal-tabla .detalle-list { margin: 0; padding-left: 1rem; font-size: 0.85rem; color: #555; list-style: none; }
    .modal-tabla .detalle-list li { margin-bottom: 0.35rem; padding: 0.15rem 0; border-bottom: 1px solid #eee; }
    .modal-tabla .detalle-list li:last-child { border-bottom: none; }
    .modal-tabla .conv-detalle { font-size: 0.82em; color: #777; margin-left: 0.35rem; }
    .modal-tabla .origen-detalle { font-size: 0.8em; color: #888; margin-left: 0.35rem; }
    .modal-tabla .detalle-tabla { width: 100%; border-collapse: collapse; font-size: 0.85rem; color: #444; margin: 0.25rem 0; }
    .modal-tabla .detalle-tabla th, .modal-tabla .detalle-tabla td { border-bottom: 1px solid #e6e6e6; padding: 0.45rem 0.55rem; vertical-align: top; }
    .modal-tabla .detalle-tabla th { background: #f2f3f5; color: #555; font-weight: 600; }
    .modal-tabla .detalle-tabla td.monto-reg { white-space: nowrap; font-weight: 600; }
    .modal-tabla .detalle-tabla td.monto-vista { white-space: nowrap; }
    .modal-tabla .detalle-tabla td.desc { color: #333; }
    .modal-tabla .detalle-tabla .muted { color: #777; }
    .modal-tabla .btn-ver-errores,
    .btn-ver-errores {
      padding: 0.35rem 0.75rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .modal-tabla .btn-ver-errores:hover,
    .btn-ver-errores:hover {
      background: #1a1a1a;
      color: #fff;
      border-color: #1a1a1a;
    }
    .modal-errores-ancho { max-width: 960px; }
    .modal-evolucion-detalle-ancho { max-width: 960px; }
    .edit-btn { background: none; border: none; cursor: pointer; color: #444; padding: 0.35rem; display: inline-flex; align-items: center; justify-content: center; }
    .edit-btn:hover { color: #1a1a1a; }
    .edit-btn svg { width: 18px; height: 18px; }
    .ver-duplicado-btn { margin-right: 0.2rem; }
    .ver-duplicado-btn svg { width: 18px; height: 18px; }
    .duplicado-comparacion { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 0.75rem; }
    .duplicado-bloque { background: #f8f9fa; border-radius: 8px; padding: 0.75rem 1rem; border: 1px solid #e6e6e6; }
    .duplicado-bloque-titulo { margin: 0 0 0.5rem 0; font-size: 0.95rem; color: #555; }
    .duplicado-bloque dl { margin: 0; font-size: 0.85rem; }
    .duplicado-bloque dt { font-weight: 600; color: #444; margin-top: 0.35rem; }
    .duplicado-bloque dt:first-child { margin-top: 0; }
    .duplicado-bloque dd { margin: 0.15rem 0 0 0; color: #333; }
    #modal-duplicado .btn-excluir-calc { background: #b45309; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    #modal-duplicado .btn-excluir-calc:hover { background: #9a4607; }
    #modal-duplicado .btn-eliminar-reg { background: #b91c1c; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    #modal-duplicado .btn-eliminar-reg:hover { background: #991b1b; }
    #modal-editar-registro .form-group { margin-bottom: 0.75rem; }
    #modal-editar-registro label { display: block; font-weight: 600; margin-bottom: 0.25rem; font-size: 0.9rem; }
    #modal-editar-registro select, #modal-editar-registro input[type="text"], #modal-editar-registro textarea { width: 100%; padding: 0.5rem; border-radius: 6px; border: 1px solid #ccc; font-size: 0.9rem; }
    #modal-editar-registro .form-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
    .alert-icon { color: #b45309; cursor: pointer; font-size: 1.1rem; padding: 0 0.25rem; vertical-align: middle; }
    .alert-icon:hover { opacity: 0.8; }
    .alert-icon-cell { width: 2rem; text-align: center; }
    #modal-alertas .modal-body ul { margin: 0; padding-left: 1.25rem; }
    #modal-alertas .modal-body li { margin-bottom: 0.5rem; }
    .app-footer { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.85rem; color: #888; text-align: center; }
    .modal-grafico { max-width: 720px; }
    .modal-grafico-body { min-height: 280px; }
    .grafico-container { position: relative; height: 280px; width: 100%; }
    .modal-tabla .icon-btn { width: 24px; height: 24px; }
    .modal-tabla .icon-btn svg { width: 100%; height: 100%; }
    .tabs-toolbar { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 0.5rem; }
    .export-excel-btn { background: none; border: none; cursor: pointer; color: #444; padding: 0.5rem; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; }
    .export-excel-btn:hover { color: #1a1a1a; background: #eee; }
    .export-excel-btn.icon-btn { width: 36px; height: 36px; margin-left: 0.25rem; }
    .export-excel-btn.icon-btn svg { width: 22px; height: 22px; }
    .export-excel-btn .icon-excel { width: 20px; height: 20px; flex-shrink: 0; }
    .exportar-base-wrap { margin-left: auto; }
    .btn-exportar-base { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.35rem 0.75rem; border-radius: 6px; border: 1px solid #16a34a; background: #16a34a; cursor: pointer; font-size: 0.9rem; color: #fff; }
    .btn-exportar-base:hover { background: #15803d; border-color: #15803d; color: #fff; }
    .btn-exportar-base .icon-excel { width: 20px; height: 20px; color: inherit; }
    .icon-document-arrow-down { flex-shrink: 0; }
    .btn-exportar-evolucion { display: inline-flex; align-items: center; gap: 0.4rem; }
    .btn-exportar-evolucion .icon-excel { width: 20px; height: 20px; flex-shrink: 0; }
    .btn-exportar-evolucion.btn-ver-errores { background: #16a34a; color: #fff; border-color: #16a34a; }
    .btn-exportar-evolucion.btn-ver-errores:hover { background: #15803d; color: #fff; border-color: #15803d; }
  </style>
</head>
<body>
  <aside id="sidebar" class="sidebar" aria-label="Men√∫ principal">
    <button type="button" class="sidebar-toggle" id="sidebar-toggle" aria-label="Expandir men√∫">
      <span class="icon-expand" aria-hidden="true">‚ñ∂</span>
      <span class="icon-collapse" aria-hidden="true">‚óÄ</span>
    </button>
    <nav class="sidebar-nav">
      <a href="#" class="menu-item" id="menu-home" title="Home" aria-label="Home">
        <span class="menu-icon" aria-hidden="true">‚åÇ</span>
        <span class="menu-label">Home</span>
      </a>
    </nav>
  </aside>
  <main id="main-content" class="main-content">
  <h1>Flujo de caja</h1>
  <p style="color:#666; margin-top:0;">Entradas y salidas por mes. No se incluyen transacciones anuladas. Si no hay cotizaci√≥n para la fecha, se usa la inmediata anterior. Hac√© clic en un mes para ver el detalle por categor√≠a.</p>

  <div id="loading" class="card loading">Cargando transacciones y tipos de cambio‚Ä¶</div>
  <div id="error" class="card error" style="display:none;"></div>

  <div id="filtros-wrap" style="display:none;" class="filtros card">
    <label>
      <span>Moneda:</span>
      <div class="toggle-moneda" id="toggle-moneda" role="group" aria-label="Moneda">
        <button type="button" class="activo" data-moneda="ARS">ARS</button>
        <button type="button" data-moneda="USD">USD</button>
      </div>
    </label>
    <label id="label-tipo-dolar" style="display:none;">
      <span>Conversi√≥n a d√≥lar:</span>
      <select id="tipoDolar">
        <option value="mep">MEP</option>
        <option value="ccl">CCL</option>
        <option value="oficial">Oficial</option>
      </select>
    </label>
    <div class="exportar-base-wrap">
      <button type="button" class="btn-exportar-base export-excel-btn" id="btn-exportar-excel" title="Exportar base de transacciones a Excel" aria-label="Exportar Base Hist√≥rica">
        <svg class="icon-excel icon-document-arrow-down" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m.75 12 3 3m0 0 3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"/></svg> Exportar Base Hist√≥rica
      </button>
    </div>
  </div>

  <div id="resumen" class="resumen" style="display:none;"></div>

  <div id="tabla-wrap" style="display:none;">
    <div class="tabs-toolbar">
      <div class="tabs">
        <button type="button" class="tab activo" data-panel="flujo">Flujo por mes</button>
        <button type="button" class="tab" data-panel="sin-cotizacion">Sin cotizaci√≥n</button>
        <button type="button" class="tab" data-panel="errores-global">Errores</button>
        <button type="button" class="tab" data-panel="evolucion">Evoluci√≥n</button>
      </div>
    </div>
    <div id="panel-flujo" class="card panel activo">
      <table>
        <thead>
          <tr>
            <th>Mes-A√±o</th>
            <th>Ingresos</th>
            <th>Egresos</th>
            <th>Balance</th>
            <th>Comisiones/Ventas %</th>
            <th>Egr s/com. / Ingresos</th>
            <th class="alert-icon-cell"></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="panel-sin-cotizacion" class="card panel">
      <p class="sin-cotizacion-note">Transacciones sin tipo de cambio (ni fecha exacta ni anterior). Excluidas del resumen y del flujo por mes.</p>
      <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Medio</th>
            <th>Descripci√≥n</th>
            <th>Monto orig.</th>
          </tr>
        </thead>
        <tbody id="tbody-sin-cotizacion"></tbody>
      </table>
    </div>
    <div id="panel-errores-global" class="card panel">
      <div class="errores-panel-toolbar">
        <p class="sin-cotizacion-note" style="margin:0;">Registros de egresos con posibles inconsistencias entre categor√≠a, cuenta contable y descripci√≥n. Pueden corregirse desde el icono de edici√≥n.</p>
        <div class="errores-filtros">
          <label for="filtro-tipo-error">Tipo de error:</label>
          <select id="filtro-tipo-error" title="Filtrar por tipo de error">
            <option value="todos">Todos</option>
            <option value="inconsistencia">Inconsistencia (categor√≠a / cuenta / descripci√≥n)</option>
            <option value="duplicado">Potencial registro duplicado</option>
          </select>
        </div>
        <button type="button" class="btn-ver-errores" id="btn-exportar-errores" title="Exportar lista de errores a Excel">Exportar errores a Excel</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>Tipo de error</th>
            <th>Fecha</th>
            <th>Mes-A√±o</th>
            <th>Tipo</th>
            <th>Categor√≠a orig.</th>
            <th>Categor√≠a mostrada</th>
            <th>Cuenta contable</th>
            <th>Medio</th>
            <th>Monto</th>
            <th>Moneda</th>
            <th>Descripci√≥n</th>
            <th>Origen</th>
            <th>Editado</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody-errores-global"></tbody>
      </table>
    </div>
    <div id="panel-evolucion" class="card panel">
      <div class="errores-panel-toolbar">
        <p class="sin-cotizacion-note" style="margin:0;">Tabla din√°mica: filas por agrupaci√≥n, columnas por per√≠odo. Valores en la moneda seleccionada (ARS/USD).</p>
        <div class="errores-filtros">
          <label for="evolucion-agrupar">Agrupar por:</label>
          <select id="evolucion-agrupar" title="Fila de la tabla">
            <option value="categoria">Categor√≠a</option>
            <option value="cuenta">Cuenta contable</option>
          </select>
          <label for="evolucion-periodo" style="margin-left:0.75rem;">Per√≠odo:</label>
          <select id="evolucion-periodo" title="Columna de la tabla">
            <option value="mensual">Mensual (MM-YYYY)</option>
            <option value="diario">Diario (fecha)</option>
          </select>
        </div>
        <button type="button" class="btn-ver-errores btn-exportar-evolucion" id="btn-exportar-evolucion" title="Exportar tabla Evoluci√≥n a Excel"><svg class="icon-excel icon-document-arrow-down" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m.75 12 3 3m0 0 3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"/></svg> Exportar Evoluci√≥n a Excel</button>
      </div>
      <div class="evolucion-table-wrap">
        <table id="tabla-evolucion">
          <thead id="thead-evolucion"></thead>
          <tbody id="tbody-evolucion"></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer class="app-footer">
    ¬© 2025 Developed by L&amp;P Financial Consulting
  </footer>
  </main>

  <div id="modal-alertas-backdrop" class="modal-backdrop oculto">
    <div class="modal" id="modal-alertas">
      <div class="modal-header" id="modal-alertas-header-drag">
        <h2 id="modal-alertas-titulo">Alertas del mes</h2>
        <button type="button" class="modal-close" id="modal-alertas-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body" id="modal-alertas-body"></div>
    </div>
  </div>

  <div id="modal-backdrop" class="modal-backdrop oculto">
    <div class="modal" id="modal-caja">
      <div class="modal-header" id="modal-header-drag">
        <h2 id="modal-titulo">Detalle del mes</h2>
        <button type="button" class="modal-close" id="modal-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <div id="modal-grafico-backdrop" class="modal-backdrop oculto">
    <div class="modal modal-grafico" id="modal-grafico">
      <div class="modal-header" id="modal-grafico-header-drag">
        <h2 id="modal-grafico-titulo">Serie mensual</h2>
        <button type="button" class="modal-close" id="modal-grafico-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body modal-grafico-body">
        <div class="grafico-container"><canvas id="chart-serie-mensual"></canvas></div>
      </div>
    </div>
  </div>

  <div id="modal-errores-backdrop" class="modal-backdrop oculto">
    <div class="modal modal-errores-ancho" id="modal-errores">
      <div class="modal-header" id="modal-errores-header-drag">
        <h2 id="modal-errores-titulo">Errores de clasificaci√≥n</h2>
        <button type="button" class="modal-close" id="modal-errores-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body" id="modal-errores-body"></div>
    </div>
  </div>

  <div id="modal-editar-backdrop" class="modal-backdrop oculto">
    <div class="modal" id="modal-editar-registro">
      <div class="modal-header" id="modal-editar-header-drag">
        <h2 id="modal-editar-titulo">Editar registro</h2>
        <button type="button" class="modal-close" id="modal-editar-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body" id="modal-editar-body">
        <div class="form-group">
          <label>Fecha</label>
          <input type="text" id="edit-fecha" readonly disabled style="background:#f0f0f0;">
        </div>
        <div class="form-group">
          <label>Categor√≠a</label>
          <select id="edit-categoria"></select>
        </div>
        <div class="form-group">
          <label>Cuenta contable</label>
          <select id="edit-cuenta-contable"></select>
        </div>
        <div class="form-group">
          <label>Descripci√≥n</label>
          <input type="text" id="edit-descripcion" placeholder="Texto libre">
        </div>
        <div class="form-actions">
          <button type="button" id="edit-guardar">Guardar</button>
          <button type="button" id="edit-cancelar">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-duplicado-backdrop" class="modal-backdrop oculto">
    <div class="modal" id="modal-duplicado">
      <div class="modal-header" id="modal-duplicado-header-drag">
        <h2 id="modal-duplicado-titulo">Posible registro duplicado</h2>
        <button type="button" class="modal-close" id="modal-duplicado-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body" id="modal-duplicado-body">
        <p class="sin-cotizacion-note" style="margin-top:0;">Compar√° los dos registros. Si confirm√°s que es duplicado, pod√©s excluir este registro de los c√°lculos (anular) o eliminarlo.</p>
        <div class="duplicado-comparacion">
          <div class="duplicado-bloque">
            <h3 class="duplicado-bloque-titulo">Este registro</h3>
            <div id="modal-duplicado-este"></div>
          </div>
          <div class="duplicado-bloque">
            <h3 class="duplicado-bloque-titulo">Posible duplicado (otro registro)</h3>
            <div id="modal-duplicado-otro"></div>
          </div>
        </div>
        <div class="form-actions" style="margin-top:1rem;">
          <button type="button" id="modal-duplicado-excluir" class="btn-excluir-calc">Excluir de c√°lculos (anular)</button>
          <button type="button" id="modal-duplicado-eliminar" class="btn-eliminar-reg">Eliminar registro</button>
          <button type="button" id="modal-duplicado-cerrar">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal-evolucion-detalle-backdrop" class="modal-backdrop oculto">
    <div class="modal modal-evolucion-detalle-ancho" id="modal-evolucion-detalle">
      <div class="modal-header" id="modal-evolucion-detalle-header-drag">
        <h2 id="modal-evolucion-detalle-titulo">Detalle</h2>
        <button type="button" class="modal-close" id="modal-evolucion-detalle-close" aria-label="Cerrar">&times;</button>
      </div>
      <div class="modal-body" id="modal-evolucion-detalle-body">
        <table class="detalle-tabla">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Categor√≠a</th>
              <th>Descripci√≥n</th>
              <th>Monto</th>
              <th>Origen</th>
            </tr>
          </thead>
          <tbody id="tbody-evolucion-detalle"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://moeqgzezdraknwmheheu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vZXFnemV6ZHJha253bWhlaGV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNTY2MDgsImV4cCI6MjA3MDkzMjYwOH0.ZHIJjZv7izlaegfeypj8s6jNb0ls-LTrt914qhgO_uA';

    if (typeof window.supabase === 'undefined') {
      throw new Error('No se pudo cargar la librer√≠a de Supabase. Revis√° la conexi√≥n a internet.');
    }
    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const MESES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    function formatoMesAnio(mes, anio) {
      return String(mes).padStart(2, '0') + '-' + anio;
    }

    function formatearNumero(n, moneda) {
      if (n == null || isNaN(n)) return '‚Äì';
      return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: moneda === 'USD' ? 2 : 0 }).format(n);
    }

    function esMonedaUSD(medioPago) {
      return (medioPago || '').toLowerCase().indexOf('dolar') !== -1;
    }

    /** Moneda de la transacci√≥n: prioriza campo moneda en BD; si no existe, infiere desde medio_pago. */
    function esTransaccionUSD(r) {
      const m = (r.moneda || '').toString().trim().toUpperCase();
      if (m === 'USD') return true;
      if (m === 'ARS') return false;
      return esMonedaUSD(r.medio_pago);
    }

    function fechaStr(f) {
      if (!f) return '';
      if (typeof f === 'string') return f.slice(0, 10);
      if (typeof f === 'object' && f instanceof Date) return f.toISOString().slice(0, 10);
      if (typeof f === 'object' && f.toISOString) return f.toISOString().slice(0, 10);
      return String(f).slice(0, 10);
    }

    function excluirCategoria(c) {
      const t = (c || '').trim();
      return t === 'Apertura' || t === 'Cierre';
    }

    function textoIndicaComision(desc, catDesc) {
      const d = ((desc || '') + ' ' + (catDesc || '')).toLowerCase();
      return d.includes('comision') || d.includes('comisones');
    }

    function getCategoriaDisplay(cat, desc, catDesc) {
      const c = (cat || '').trim().toLowerCase();
      if (c.includes('sueldos')) return textoIndicaComision(desc, catDesc) ? 'Comisiones' : 'Sueldos';
      if (c === 'alquiler') return 'Alquileres y Servicios';
      return (cat || '').trim() || 'Sin categor√≠a';
    }

    function esComisionDentroSueldos(cat, desc, catDesc) {
      const c = (cat || '').trim().toLowerCase();
      if (!c.includes('sueldos')) return false;
      return textoIndicaComision(desc, catDesc);
    }

    // Valida consistencia entre categor√≠a, cuenta contable y descripci√≥n (solo Egresos).
    function esDescripcionConsistenteConCategoriaYCuenta(r) {
      if (!r || r.tipo_movimiento !== 'Egreso') return true;
      const catOrig = (r.categoria || '').trim().toLowerCase();
      const cuentaOrig = (r.cuenta_contable || '').trim().toLowerCase();
      // Excepci√≥n: Comisiones Bancarias / Gastos Bancarios se considera consistente
      if (catOrig === 'comisiones bancarias' && cuentaOrig === 'gastos bancarios') return true;
      // Excepci√≥n: Impuestos / MercadoPago se considera consistente
      if (catOrig === 'impuestos' && cuentaOrig === 'mercadopago') return true;
      // Excepci√≥n: Impuestos / Transferencia Morba se considera consistente
      if (catOrig === 'impuestos' && cuentaOrig === 'transferencia morba') return true;
      // Excepci√≥n: Alquileres y Servicios (categor√≠a Alquiler) / Cuenta Alquiler se considera consistente
      if (catOrig === 'alquiler' && cuentaOrig === 'alquiler') return true;
      const descBase = ((r.descripcion || '') + ' ' + (r.cat_desc || '') + ' ' + (r.cliente || '')).toLowerCase();
      const cuenta = (r.cuenta_contable || '').toString().toLowerCase();
      const catDisplay = getCategoriaDisplay(r.categoria, r.descripcion, r.cat_desc).toString().toLowerCase();
      const tokens = [];
      function agregarTokens(texto) {
        texto.split(/[^a-z√°√©√≠√≥√∫√º√±0-9]+/i).forEach(t => {
          const tok = t.trim();
          if (tok.length >= 3 && !tokens.includes(tok)) tokens.push(tok);
        });
      }
      agregarTokens(catDisplay);
      agregarTokens(cuenta);
      if (!tokens.length) return true;
      const desc = descBase;
      return tokens.some(t => desc.indexOf(t) !== -1);
    }

    function getCategoriaDisplayConValidacion(r) {
      const base = getCategoriaDisplay(r.categoria, r.descripcion, r.cat_desc);
      if (!esDescripcionConsistenteConCategoriaYCuenta(r)) {
        return { categoria: 'Sin categor√≠a', esError: true, baseCategoria: base };
      }
      return { categoria: base, esError: false, baseCategoria: base };
    }

    const TIPO_ERROR_INCONSISTENCIA = 'Inconsistencia entre Categoria, Cuenta Contable y Descripcion';
    const TIPO_ERROR_DUPLICADO = 'Potencial registro duplicado';

    function descripcionSimilar(descA, descB) {
      const na = (descA || '').trim().toLowerCase().replace(/\s+/g, ' ');
      const nb = (descB || '').trim().toLowerCase().replace(/\s+/g, ' ');
      if (!na || !nb) return na === nb;
      if (na.length < 3 && nb.length < 3) return na === nb;
      return na === nb || na.includes(nb) || nb.includes(na) || na.slice(0, 20) === nb.slice(0, 20);
    }

    function getPosibleDuplicado(r, lista) {
      const idR = (r.id || '').toString();
      const fechaR = fechaStr(r.fecha);
      const montoR = Number(r.monto);
      const tipoR = (r.tipo_movimiento || '').trim();
      const clienteR = (r.cliente || '').trim();
      if (!fechaR || (montoR !== 0 && !montoR)) return null;
      for (let i = 0; i < lista.length; i++) {
        const s = lista[i];
        if ((s.id || '').toString() === idR) continue;
        if (fechaStr(s.fecha) !== fechaR) continue;
        if (Number(s.monto) !== montoR) continue;
        if ((s.tipo_movimiento || '').trim() !== tipoR) continue;
        if ((s.cliente || '').trim() !== clienteR) continue;
        if (!descripcionSimilar(r.descripcion || r.cliente, s.descripcion || s.cliente)) continue;
        return s;
      }
      return null;
    }

    function getErroresDuplicados() {
      const lista = cacheTransacciones.filter(r => !excluirCategoria(r.categoria));
      const out = [];
      lista.forEach(r => {
        const otro = getPosibleDuplicado(r, lista);
        if (otro) out.push({ ...r, tipoError: TIPO_ERROR_DUPLICADO, registroPosibleDuplicado: otro });
      });
      return out;
    }

    let cacheTransacciones = [];
    let cacheTC = {};
    let fechasConTasa = { mep: [], ccl: [], oficial: [] };

    function getTasaAnterior(fecha, rateKey) {
      if (!fecha || !rateKey) return null;
      const list = fechasConTasa[rateKey];
      if (!list || list.length === 0) return null;
      let idx = list.findIndex(d => d > fecha);
      if (idx === -1) idx = list.length;
      if (idx === 0) return null;
      const fechaAnterior = list[idx - 1];
      const tc = cacheTC[fechaAnterior];
      return tc && tc[rateKey] != null && tc[rateKey] > 0 ? tc[rateKey] : null;
    }

    const CARGA_TIMEOUT_MS = 25000;

    function withTimeout(promise, ms, msg) {
      return Promise.race([
        promise,
        new Promise((_, reject) => setTimeout(() => reject(new Error(msg || 'Tiempo de espera agotado')), ms))
      ]);
    }

    async function cargarDatos() {
      const txPromise = client.from('transacciones').select('id, id_origen, fecha, mes, anio, tipo_movimiento, monto, status, medio_pago, moneda, descripcion, cliente, categoria, cat_desc, origen_archivo, cuenta_contable, editado, editado_detalle').neq('status', 'Anulado');
      const tcPromise = client.from('tipo_de_cambio').select('fecha, usd_mep, usd_ccl, usd_oficial');
      const [txRes, tcRes] = await withTimeout(
        Promise.all([txPromise, tcPromise]),
        CARGA_TIMEOUT_MS,
        'La carga de datos tard√≥ demasiado. Revis√° la conexi√≥n o intent√° de nuevo.'
      );
      if (txRes.error) throw txRes.error;
      if (tcRes.error) throw tcRes.error;
      cacheTransacciones = txRes.data || [];
      const tcs = tcRes.data || [];
      const map = {};
      tcs.forEach(r => {
        const f = fechaStr(r.fecha);
        if (!f) return;
        if (!map[f]) map[f] = { mep: r.usd_mep != null ? Number(r.usd_mep) : null, ccl: r.usd_ccl != null ? Number(r.usd_ccl) : null, oficial: r.usd_oficial != null ? Number(r.usd_oficial) : null };
      });
      cacheTC = map;
      ['mep','ccl','oficial'].forEach(rateKey => {
        fechasConTasa[rateKey] = Object.keys(map).filter(d => map[d][rateKey] != null && map[d][rateKey] > 0).sort();
      });
      return { transacciones: cacheTransacciones, tcMap: cacheTC };
    }

    function getMoneda() {
      return document.querySelector('#toggle-moneda button.activo')?.getAttribute('data-moneda') || 'ARS';
    }

    function recalcular() {
      const moneda = getMoneda();
      const tipoDolar = document.getElementById('tipoDolar').value;
      const rows = cacheTransacciones;

      const porMes = {};
      const porMesCategoria = {};
      let totalIngresos = 0, totalEgresos = 0;
      const sinCotizacion = [];

      rows.filter(r => !excluirCategoria(r.categoria)).forEach(r => {
        const montoOrig = Number(r.monto) || 0;
        const fecha = fechaStr(r.fecha);
        let tasa = (cacheTC[fecha] && cacheTC[fecha][tipoDolar] != null && cacheTC[fecha][tipoDolar] > 0) ? cacheTC[fecha][tipoDolar] : getTasaAnterior(fecha, tipoDolar);

        let montoParaSumar = montoOrig;
        const esUSD = esTransaccionUSD(r);

        if (moneda === 'USD') {
          if (esUSD) {
            montoParaSumar = montoOrig;
          } else {
            if (tasa == null) { sinCotizacion.push(r); return; }
            montoParaSumar = montoOrig / tasa;
          }
        } else {
          if (esUSD) {
            if (tasa == null) { sinCotizacion.push(r); return; }
            montoParaSumar = montoOrig * tasa;
          }
        }

        const key = `${r.anio}-${String(r.mes).padStart(2,'0')}`;
        const cat = (r.categoria || '').trim() || 'Sin categor√≠a';
        const catLow = cat.toLowerCase();
        if (!porMes[key]) porMes[key] = { anio: r.anio, mes: r.mes, ingresos: 0, egresos: 0, comisiones: 0, ventas: 0 };
        if (!porMesCategoria[key]) porMesCategoria[key] = {};
        if (!porMesCategoria[key][cat]) porMesCategoria[key][cat] = 0;
        porMesCategoria[key][cat] += montoParaSumar;
        if (r.tipo_movimiento === 'Ingreso') {
          porMes[key].ingresos += montoParaSumar;
          totalIngresos += montoParaSumar;
          if (catLow.includes('venta')) porMes[key].ventas += montoParaSumar;
        } else if (r.tipo_movimiento === 'Egreso') {
          porMes[key].egresos += montoParaSumar;
          totalEgresos += montoParaSumar;
          if (esComisionDentroSueldos(r.categoria, r.descripcion, r.cat_desc)) porMes[key].comisiones += montoParaSumar;
        }
      });

      const ordenados = Object.keys(porMes).sort();
      const categoriasEnMes = {};
      ordenados.forEach(key => {
        const [anio, mes] = [parseInt(key.slice(0, 4), 10), parseInt(key.slice(5), 10)];
        const trans = cacheTransacciones.filter(r => r.anio === anio && r.mes === mes && !excluirCategoria(r.categoria));
        categoriasEnMes[key] = [...new Set(trans.map(r => getCategoriaDisplayConValidacion(r).categoria))];
      });
      const UMBRAL_DESVIO_PCT = 25;
      const categoriasEsperadas = [
        { nombre: 'Sueldos', tiene: (arr) => arr.includes('Sueldos') },
        { nombre: 'Comisiones', tiene: (arr) => arr.includes('Comisiones') },
        { nombre: 'Alquileres', tiene: (arr) => arr.some(c => (c || '').toLowerCase().includes('alquiler')) },
        { nombre: 'Impuestos', tiene: (arr) => arr.some(c => (c || '').toLowerCase().includes('impuesto')) }
      ];
      const alertasPorMes = {};
      ordenados.forEach((key, idx) => {
        const alertas = [];
        const d = porMes[key];
        if (d.egresos === 0 || (typeof d.egresos === 'number' && d.egresos < 1e-6)) alertas.push('El mes no tiene egresos.');
        categoriasEsperadas.forEach(({ nombre, tiene }) => {
          if (!tiene(categoriasEnMes[key] || [])) alertas.push('No hay registros de ' + nombre + ' en el mes.');
        });
        if (idx > 0) {
          const prevKey = ordenados[idx - 1];
          Object.keys(porMesCategoria[key] || {}).forEach(cat => {
            const actual = porMesCategoria[key][cat] || 0;
            const anterior = porMesCategoria[prevKey] && porMesCategoria[prevKey][cat] != null ? porMesCategoria[prevKey][cat] : 0;
            if (anterior > 0 && actual >= 0) {
              const desvioPct = Math.abs((actual - anterior) / anterior * 100);
              if (desvioPct >= UMBRAL_DESVIO_PCT) alertas.push('La categor√≠a "' + cat + '" tiene un desv√≠o de ' + desvioPct.toFixed(1) + '% respecto del mes anterior.');
            }
          });
        }
        alertasPorMes[key] = alertas;
      });
      const balanceTotal = totalIngresos - totalEgresos;
      const simbolo = moneda === 'USD' ? 'US$ ' : '$ ';

      document.getElementById('resumen').innerHTML = `
        <div class="card"><div style="color:#555;">Total ingresos</div><div class="valor ingresos">${simbolo}${formatearNumero(totalIngresos, moneda)}</div></div>
        <div class="card"><div style="color:#555;">Total egresos</div><div class="valor egresos">${simbolo}${formatearNumero(totalEgresos, moneda)}</div></div>
        <div class="card"><div style="color:#555;">Balance</div><div class="valor balance ${balanceTotal >= 0 ? 'positivo' : 'negativo'}">${simbolo}${formatearNumero(balanceTotal, moneda)}</div></div>
      `;
      document.getElementById('resumen').style.display = 'flex';

      const tbody = document.getElementById('tbody');
      tbody.innerHTML = ordenados.map(key => {
        const d = porMes[key];
        const balance = d.ingresos - d.egresos;
        const label = formatoMesAnio(d.mes, d.anio);
        const comisiones = d.comisiones != null ? d.comisiones : 0;
        const ventas = d.ventas != null ? d.ventas : 0;
        const comVentasPct = ventas > 0 ? ((comisiones / ventas) * 100).toFixed(1) + '%' : '‚Äì';
        const egrSinCom = (d.egresos != null ? d.egresos : 0) - comisiones;
        const egrSinComIngPct = d.ingresos > 0 ? ((egrSinCom / d.ingresos) * 100).toFixed(1) + '%' : '‚Äì';
        const alertas = alertasPorMes[key] || [];
        const alertasJson = alertas.length ? JSON.stringify(alertas).replace(/"/g, '&quot;') : '';
        const iconoAlert = alertas.length ? `<span class="alert-icon" role="button" tabindex="0" data-alertas="${alertasJson}" data-label="${label.replace(/"/g, '&quot;')}" title="Ver alertas">‚ö†Ô∏è</span>` : '';
        return `<tr class="fila-mes" data-anio="${d.anio}" data-mes="${d.mes}">
          <td>${label}</td>
          <td class="ingresos">${simbolo}${formatearNumero(d.ingresos, moneda)}</td>
          <td class="egresos">${simbolo}${formatearNumero(d.egresos, moneda)}</td>
          <td class="balance ${balance >= 0 ? 'positivo' : 'negativo'}">${simbolo}${formatearNumero(balance, moneda)}</td>
          <td>${comVentasPct}</td>
          <td>${egrSinComIngPct}</td>
          <td class="alert-icon-cell">${iconoAlert}</td>
        </tr>`;
      }).join('');

      document.getElementById('tbody-sin-cotizacion').innerHTML = sinCotizacion.length === 0
        ? '<tr><td colspan="5" style="text-align:center; color:#666;">No hay transacciones sin cotizaci√≥n.</td></tr>'
        : sinCotizacion.map(r => `
          <tr>
            <td>${fechaStr(r.fecha)}</td>
            <td>${(r.tipo_movimiento || '').replace(/</g,'&lt;')}</td>
            <td>${(r.medio_pago || '').replace(/</g,'&lt;')}</td>
            <td>${(r.descripcion || r.cliente || '‚Äì').slice(0, 60).replace(/</g,'&lt;')}</td>
            <td>${formatearNumero(r.monto)}</td>
          </tr>
        `).join('');

      renderErroresGlobal();
      renderEvolucion();
    }

    let evolucionDetalle = {};
    let evolucionMatrix = {};
    let evolucionColumnasOrdenadas = [];
    let evolucionFilasOrdenadas = [];
    let evolucionMoneda = 'ARS';
    let evolucionSimbolo = '$ ';

    function formatearColHeaderEvolucion(key, periodo) {
      if (periodo === 'diario') {
        if (key.length >= 10) {
          const [y, m, d] = key.split('-');
          return (d || '') + '/' + (m || '') + '/' + (y || '');
        }
        return key;
      }
      const [anio, mes] = key.split('-');
      return (mes || '') + '-' + (anio || '');
    }

    function abrirModalEvolucionDetalle(rowKey, colKey) {
      const list = evolucionDetalle[rowKey] && (colKey === '__total__' ? evolucionDetalle[rowKey].__total__ : evolucionDetalle[rowKey][colKey]);
      const backdrop = document.getElementById('modal-evolucion-detalle-backdrop');
      const titulo = document.getElementById('modal-evolucion-detalle-titulo');
      const tbodyDet = document.getElementById('tbody-evolucion-detalle');
      if (!backdrop || !titulo || !tbodyDet) return;
      const periodo = (document.getElementById('evolucion-periodo') && document.getElementById('evolucion-periodo').value) || 'mensual';
      const colLabel = colKey === '__total__' ? 'Total' : formatearColHeaderEvolucion(colKey, periodo);
      titulo.textContent = 'Detalle ‚Äî ' + (rowKey || '').replace(/</g, '&lt;') + (colKey !== '__total__' ? ' ¬∑ ' + colLabel : ' (' + colLabel + ')');
      if (!list || list.length === 0) {
        tbodyDet.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#666;">No hay registros.</td></tr>';
      } else {
        const esc = (v) => (v == null ? '' : String(v)).replace(/</g, '&lt;');
        tbodyDet.innerHTML = list.map(item => `
          <tr>
            <td>${esc(item.fecha)}</td>
            <td>${esc(item.categoria)}</td>
            <td>${esc((item.descripcion || '‚Äî').slice(0, 200))}</td>
            <td class="${item.monto >= 0 ? 'ingresos' : 'egresos'}">${evolucionSimbolo}${formatearNumero(item.monto, evolucionMoneda)}</td>
            <td>${esc(item.origen_archivo || '‚Äî')}</td>
          </tr>
        `).join('');
      }
      backdrop.classList.remove('oculto');
    }

    function renderEvolucion() {
      const thead = document.getElementById('thead-evolucion');
      const tbody = document.getElementById('tbody-evolucion');
      if (!thead || !tbody) return;
      const agrupar = (document.getElementById('evolucion-agrupar') && document.getElementById('evolucion-agrupar').value) || 'categoria';
      const periodo = (document.getElementById('evolucion-periodo') && document.getElementById('evolucion-periodo').value) || 'mensual';
      const moneda = getMoneda();
      evolucionMoneda = moneda;
      evolucionSimbolo = moneda === 'USD' ? 'US$ ' : '$ ';
      const tipoDolar = document.getElementById('tipoDolar') ? document.getElementById('tipoDolar').value : 'mep';

      const matrix = {};
      const detalle = {};
      const columnasSet = new Set();

      cacheTransacciones.filter(r => !excluirCategoria(r.categoria)).forEach(r => {
        const montoConv = montoConvertido(r, moneda, tipoDolar);
        if (montoConv == null) return;
        const signo = r.tipo_movimiento === 'Ingreso' ? 1 : -1;
        const valor = signo * montoConv;
        const rowKey = agrupar === 'categoria'
          ? (getCategoriaDisplay(r.categoria, r.descripcion, r.cat_desc) || 'Sin categor√≠a')
          : ((r.cuenta_contable || '').trim() || '‚Äî');
        let colKey;
        if (periodo === 'diario') {
          colKey = fechaStr(r.fecha);
          if (!colKey) return;
        } else {
          const anio = r.anio != null ? r.anio : (r.fecha ? new Date(r.fecha).getFullYear() : null);
          const mes = r.mes != null ? r.mes : (r.fecha ? new Date(r.fecha).getMonth() + 1 : null);
          if (anio == null || mes == null) return;
          colKey = anio + '-' + String(mes).padStart(2, '0');
        }
        columnasSet.add(colKey);
        if (!matrix[rowKey]) matrix[rowKey] = {};
        matrix[rowKey][colKey] = (matrix[rowKey][colKey] || 0) + valor;
        if (!detalle[rowKey]) detalle[rowKey] = {};
        if (!detalle[rowKey][colKey]) detalle[rowKey][colKey] = [];
        detalle[rowKey][colKey].push({
          fecha: fechaStr(r.fecha),
          categoria: getCategoriaDisplay(r.categoria, r.descripcion, r.cat_desc) || r.categoria || '‚Äî',
          descripcion: (r.descripcion || r.cliente || '').trim() || '‚Äî',
          monto: valor,
          origen_archivo: (r.origen_archivo || '').trim() || '‚Äî'
        });
      });

      const columnasOrdenadas = Array.from(columnasSet).sort();
      const rowKeys = Object.keys(matrix);
      const rowTotals = {};
      rowKeys.forEach(rk => {
        let t = 0;
        columnasOrdenadas.forEach(ck => { t += matrix[rk][ck] || 0; });
        rowTotals[rk] = t;
      });
      const filasOrdenadas = rowKeys.sort((a, b) => {
        const ta = rowTotals[a], tb = rowTotals[b];
        if (ta >= 0 && tb < 0) return -1;
        if (ta < 0 && tb >= 0) return 1;
        return a.localeCompare(b);
      });

      filasOrdenadas.forEach(rowKey => {
        if (!detalle[rowKey].__total__) detalle[rowKey].__total__ = [];
        columnasOrdenadas.forEach(colKey => {
          if (detalle[rowKey][colKey]) detalle[rowKey].__total__ = detalle[rowKey].__total__.concat(detalle[rowKey][colKey]);
        });
      });
      evolucionDetalle = detalle;
      evolucionMatrix = matrix;
      evolucionColumnasOrdenadas = columnasOrdenadas;
      evolucionFilasOrdenadas = filasOrdenadas;

      const esc = (v) => (v == null ? '' : String(v)).replace(/</g, '&lt;');
      const simbolo = evolucionSimbolo;

      const formatearColHeader = (key) => formatearColHeaderEvolucion(key, periodo);

      thead.innerHTML = '<tr><th>' + esc(agrupar === 'categoria' ? 'Categor√≠a' : 'Cuenta contable') + '</th>' + columnasOrdenadas.map(c => '<th>' + esc(formatearColHeader(c)) + '</th>').join('') + '<th>Total</th></tr>';
      if (filasOrdenadas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="' + (columnasOrdenadas.length + 2) + '" style="text-align:center; color:#666;">No hay datos para mostrar.</td></tr>';
        return;
      }
      tbody.innerHTML = filasOrdenadas.map(rowKey => {
        let totalFila = 0;
        const celdas = columnasOrdenadas.map(colKey => {
          const v = matrix[rowKey][colKey] || 0;
          totalFila += v;
          const cls = v > 0 ? 'ingresos' : (v < 0 ? 'egresos' : '');
          const tieneDetalle = (detalle[rowKey][colKey] || []).length > 0;
          const clickable = tieneDetalle ? ' evolucion-clickable' : '';
          const dataAttrs = tieneDetalle ? ' data-rowkey="' + esc(rowKey).replace(/"/g, '&quot;') + '" data-colkey="' + esc(colKey).replace(/"/g, '&quot;') + '"' : '';
          return '<td class="num-evolucion ' + cls + clickable + '"' + dataAttrs + '>' + (v !== 0 ? simbolo + formatearNumero(v, moneda) : '‚Äî') + '</td>';
        });
        const totalCls = totalFila >= 0 ? 'balance positivo' : 'balance negativo';
        const totalList = (detalle[rowKey].__total__ || []).length;
        const totalAttrs = totalList > 0 ? ' data-rowkey="' + esc(rowKey).replace(/"/g, '&quot;') + '" data-colkey="__total__" class="num-evolucion ' + totalCls + ' evolucion-clickable"' : ' class="num-evolucion ' + totalCls + '"';
        return '<tr><td>' + esc(rowKey) + '</td>' + celdas.join('') + '<td' + totalAttrs + '>' + simbolo + formatearNumero(totalFila, moneda) + '</td></tr>';
      }).join('');

      tbody.querySelectorAll('.evolucion-clickable').forEach(td => {
        td.addEventListener('click', () => {
          const rk = td.getAttribute('data-rowkey');
          const ck = td.getAttribute('data-colkey');
          if (rk != null && ck != null) abrirModalEvolucionDetalle(rk, ck);
        });
      });

      thead.querySelectorAll('th').forEach((th, i) => { th.style.textAlign = i === 0 ? 'left' : 'right'; });
    }

    function exportarEvolucionExcel() {
      if (!window.XLSX || !evolucionFilasOrdenadas.length) {
        alert('No hay datos en Evoluci√≥n para exportar.');
        return;
      }
      const agrupar = (document.getElementById('evolucion-agrupar') && document.getElementById('evolucion-agrupar').value) || 'categoria';
      const periodo = (document.getElementById('evolucion-periodo') && document.getElementById('evolucion-periodo').value) || 'mensual';
      const formatearColHeader = (key) => formatearColHeaderEvolucion(key, periodo);
      const monedaExport = getMoneda();

      const headerRow = [agrupar === 'categoria' ? 'Categor√≠a' : 'Cuenta contable'].concat(evolucionColumnasOrdenadas.map(formatearColHeader)).concat(['Total']);
      const rows = [['Moneda: ' + (monedaExport === 'USD' ? 'USD' : 'ARS') + '.'], headerRow];
      evolucionFilasOrdenadas.forEach(rowKey => {
        let totalFila = 0;
        const celdas = evolucionColumnasOrdenadas.map(colKey => {
          const v = (evolucionMatrix[rowKey] && evolucionMatrix[rowKey][colKey]) || 0;
          totalFila += v;
          return v !== 0 ? v : '';
        });
        rows.push([rowKey].concat(celdas).concat([totalFila]));
      });

      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Evolucion');
      const hoy = new Date();
      const fecha = String(hoy.getDate()).padStart(2, '0') + '-' + String(hoy.getMonth() + 1).padStart(2, '0') + '-' + hoy.getFullYear();
      XLSX.writeFile(wb, 'Evolucion_Fornitalia_' + fecha + '.xlsx');
    }

    function exportarAExcel() {
      if (!window.XLSX || !cacheTransacciones.length) {
        if (!cacheTransacciones.length) alert('No hay transacciones cargadas para exportar.');
        return;
      }
      const headers = ['fecha', 'mes', 'anio', 'tipo_movimiento', 'monto', 'status', 'medio_pago', 'moneda', 'descripcion', 'cliente', 'categoria', 'cat_desc', 'origen_archivo', 'cuenta_contable', 'editado', 'editado_detalle'];
      const rows = [['Exportado: Base hist√≥rica. Moneda de cada monto: ver columna "moneda" (ARS o USD).'], headers];
      cacheTransacciones.forEach(r => {
        const montoNum = (r.monto != null && r.monto !== '') ? Number(r.monto) : '';
        rows.push([
          r.fecha != null ? r.fecha : '',
          r.mes != null ? r.mes : '',
          r.anio != null ? r.anio : '',
          (r.tipo_movimiento || '').toString(),
          montoNum,
          (r.status || '').toString(),
          (r.medio_pago || '').toString(),
          (r.moneda != null && r.moneda !== '' ? (r.moneda || '').toString().trim().toUpperCase() : ''),
          (r.descripcion || '').toString(),
          (r.cliente || '').toString(),
          (r.categoria || '').toString(),
          (r.cat_desc || '').toString(),
          (r.origen_archivo || '').toString(),
          (r.cuenta_contable || '').toString(),
          r.editado === true ? 'S√≠' : '',
          (r.editado_detalle || '').toString()
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{ wch: 12 }, { wch: 6 }, { wch: 6 }, { wch: 14 }, { wch: 14 }, { wch: 12 }, { wch: 14 }, { wch: 6 }, { wch: 36 }, { wch: 24 }, { wch: 20 }, { wch: 20 }, { wch: 18 }, { wch: 24 }, { wch: 6 }, { wch: 32 }];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Transacciones');
      const hoy = new Date();
      const fecha = String(hoy.getDate()).padStart(2, '0') + '-' + String(hoy.getMonth() + 1).padStart(2, '0') + '-' + hoy.getFullYear();
      XLSX.writeFile(wb, 'Transacciones_Fornitalia_' + fecha + '.xlsx');
    }

    function exportarErroresExcel() {
      if (!window.XLSX || !lastErroresGlobal || !lastErroresGlobal.length) {
        alert('No hay registros con error para exportar.');
        return;
      }
      const headers = ['tipo_error', 'id', 'fecha', 'mes', 'anio', 'tipo_movimiento', 'categoria_original', 'categoria_mostrada', 'cuenta_contable', 'medio_pago', 'moneda', 'monto', 'descripcion', 'cliente', 'cat_desc', 'origen_archivo', 'editado', 'editado_detalle'];
      const rows = [['Moneda de los montos: ver columna "moneda" (ARS o USD).'], headers];
      lastErroresGlobal.forEach(r => {
        const regIsUSD = esTransaccionUSD(r);
        const monedaReg = regIsUSD ? 'USD' : 'ARS';
        const montoNum = (r.monto != null && r.monto !== '') ? Number(r.monto) : '';
        rows.push([
          (r.tipoError || '').toString(),
          (r.id || '').toString(),
          r.fecha != null ? r.fecha : '',
          r.mes != null ? r.mes : '',
          r.anio != null ? r.anio : '',
          (r.tipo_movimiento || '').toString(),
          (r.categoriaOriginal || '').toString(),
          (getCategoriaDisplay(r.categoria, r.descripcion, r.cat_desc) || '').toString(),
          (r.cuenta_contable || '').toString(),
          (r.medio_pago || '').toString(),
          monedaReg,
          montoNum,
          (r.descripcion || '').toString(),
          (r.cliente || '').toString(),
          (r.cat_desc || '').toString(),
          (r.origen_archivo || '').toString(),
          r.editado === true ? 'S√≠' : '',
          (r.editado_detalle || '').toString()
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [
        { wch: 48 }, { wch: 36 }, { wch: 12 }, { wch: 6 }, { wch: 6 }, { wch: 16 },
        { wch: 26 }, { wch: 26 }, { wch: 22 }, { wch: 16 }, { wch: 8 },
        { wch: 16 }, { wch: 40 }, { wch: 22 }, { wch: 22 }, { wch: 18 },
        { wch: 8 }, { wch: 32 }
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Errores');
      const hoy = new Date();
      const fecha = String(hoy.getDate()).padStart(2, '0') + '-' + String(hoy.getMonth() + 1).padStart(2, '0') + '-' + hoy.getFullYear();
      XLSX.writeFile(wb, 'Errores_clasificacion_Fornitalia_' + fecha + '.xlsx');
    }

    function montoConvertido(r, moneda, tipoDolar) {
      const montoOrig = Number(r.monto) || 0;
      const fecha = fechaStr(r.fecha);
      let tasa = (cacheTC[fecha] && cacheTC[fecha][tipoDolar] != null && cacheTC[fecha][tipoDolar] > 0) ? cacheTC[fecha][tipoDolar] : getTasaAnterior(fecha, tipoDolar);
      const esUSD = esTransaccionUSD(r);
      if (moneda === 'USD') return esUSD ? montoOrig : (tasa != null ? montoOrig / tasa : null);
      return esUSD ? (tasa != null ? montoOrig * tasa : null) : montoOrig;
    }

    let chartSerieMensual = null;
    let lastErroresGlobal = [];

    const verticalLinePlugin = {
      id: 'verticalLineMes',
      afterDraw(chart) {
        try {
          const idx = chart.options.verticalLineIndex;
          if (idx == null || idx < 0 || idx >= (chart.data.labels || []).length) return;
          const xScale = chart.scales.x || chart.scales['x'];
          const yScale = chart.scales.y || chart.scales['y'];
          if (!xScale || !yScale) return;
          const ctx = chart.ctx;
          const x = xScale.getPixelForValue(chart.data.labels[idx]);
          const value = chart.data.datasets[0] && chart.data.datasets[0].data[idx];
          const opts = chart.options.verticalLineOpts || {};
          ctx.save();
          ctx.beginPath();
          ctx.strokeStyle = opts.lineColor || '#b91c1c';
          ctx.lineWidth = opts.lineWidth || 2;
          ctx.setLineDash(opts.dash || [6, 4]);
          ctx.moveTo(x, yScale.top);
          ctx.lineTo(x, yScale.bottom);
          ctx.stroke();
          ctx.setLineDash([]);
          if (value != null && typeof opts.formatValue === 'function') {
            const label = opts.formatValue(value);
            ctx.font = (opts.fontSize || 12) + 'px system-ui, sans-serif';
            ctx.fillStyle = opts.lineColor || '#b91c1c';
            ctx.textAlign = 'center';
            ctx.fillText(label, x, yScale.top - 8);
          }
          ctx.restore();
        } catch (e) { /* no romper el gr√°fico */ }
      }
    };
    if (typeof Chart !== 'undefined') Chart.register(verticalLinePlugin);

    function getSerieMensual(tipo, nombre) {
      const moneda = getMoneda();
      const tipoDolar = document.getElementById('tipoDolar').value;
      const rows = cacheTransacciones.filter(r => !excluirCategoria(r.categoria));
      const match = (r) => {
        if (tipo === 'categoria') return getCategoriaDisplay(r.categoria, r.descripcion, r.cat_desc) === nombre;
        const cuenta = (r.cuenta_contable || '').trim() || 'Sin cuenta contable';
        return cuenta === nombre;
      };
      const todosLosMeses = [...new Set(rows.map(r => `${r.anio}-${String(r.mes).padStart(2,'0')}`))].sort();
      const porMes = {};
      rows.filter(match).forEach(r => {
        const m = montoConvertido(r, moneda, tipoDolar);
        if (m == null) return;
        const key = `${r.anio}-${String(r.mes).padStart(2,'0')}`;
        if (!porMes[key]) porMes[key] = 0;
        porMes[key] += r.tipo_movimiento === 'Ingreso' ? m : -m;
      });
      const labels = todosLosMeses.map(k => {
        const [anio, mes] = [parseInt(k.slice(0, 4), 10), parseInt(k.slice(5), 10)];
        return formatoMesAnio(mes, anio);
      });
      const valoresNetos = todosLosMeses.map(k => porMes[k] || 0);
      const total = valoresNetos.reduce((s, v) => s + v, 0);
      const tipoMovimiento = total >= 0 ? 'Ingreso' : 'Egreso';
      const values = valoresNetos.map(v => Math.abs(v));
      return { labels, values, tipoMovimiento };
    }

    function openGraficoModal(tipo, nombre, anioSel, mesSel) {
      const titulo = document.getElementById('modal-grafico-titulo');
      const canvas = document.getElementById('chart-serie-mensual');
      if (!titulo || !canvas) return;
      const { labels, values, tipoMovimiento } = getSerieMensual(tipo, nombre);
      titulo.textContent = 'Tipo: ' + tipoMovimiento + ' ‚Äî Serie mensual: ' + (nombre || '');
      if (chartSerieMensual) { chartSerieMensual.destroy(); chartSerieMensual = null; }
      document.getElementById('modal-grafico-backdrop').classList.remove('oculto');
      const moneda = getMoneda();
      const simbolo = moneda === 'USD' ? 'US$ ' : '$ ';
      const decimals = moneda === 'USD' ? 2 : 0;
      const formatTick = (v) => typeof v === 'number' ? new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: decimals }).format(v) : v;
      const labelMesSel = (anioSel != null && mesSel != null) ? formatoMesAnio(mesSel, anioSel) : null;
      const selectedIndex = labelMesSel != null ? labels.indexOf(labelMesSel) : -1;
      const lineColor = '#444';
      const fillColor = 'rgba(68, 68, 68, 0.15)';
      const config = {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: tipoMovimiento,
            data: values,
            borderColor: lineColor,
            backgroundColor: fillColor,
            borderWidth: 2,
            fill: true,
            tension: 0.2,
            pointRadius: 4,
            pointBackgroundColor: lineColor
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: { legend: { display: false } },
          verticalLineIndex: selectedIndex >= 0 ? selectedIndex : null,
          verticalLineOpts: selectedIndex >= 0 ? { lineColor: '#b91c1c', formatValue: v => simbolo + formatTick(v) } : null,
          scales: {
            y: { min: 0, ticks: { callback: function(v) { return simbolo + formatTick(v); } } }
          }
        }
      };
      requestAnimationFrame(function() {
        chartSerieMensual = new Chart(canvas.getContext('2d'), config);
      });
    }

    function abrirModal(anio, mes) {
      const modal = document.getElementById('modal-caja');
      if (modal) {
        modal.style.position = '';
        modal.style.left = '';
        modal.style.top = '';
        modal.style.right = '';
        modal.style.transform = '';
      }
      const moneda = getMoneda();
      const tipoDolar = document.getElementById('tipoDolar').value;
      const simbolo = moneda === 'USD' ? 'US$ ' : '$ ';
      const labelMes = formatoMesAnio(mes, anio);
      const transaccionesMes = cacheTransacciones.filter(r => r.anio === anio && r.mes === mes && !excluirCategoria(r.categoria));
      const totalSolo = (items) => items.reduce((s, i) => s + (i.montoConvertido != null ? i.montoConvertido : 0), 0);
      const renderDetalleTabla = (items) => {
        const esc = (v) => (v == null ? '' : String(v)).replace(/</g, '&lt;');
        const fmtTC = (n) => typeof n === 'number'
          ? new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n)
          : '';
        const head = `
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Medio</th>
                <th>Mon.</th>
                <th>Monto</th>
                <th>${esc(moneda)}</th>
                <th>TC (${esc((tipoDolar || '').toString().toUpperCase())})</th>
                <th>Descripci√≥n</th>
                <th>Origen</th>
              </tr>
            </thead>
            <tbody>
        `;
        const body = items.map(i => {
          const regIsUSD = esTransaccionUSD(i);
          const monedaReg = regIsUSD ? 'USD' : 'ARS';
          const simboloReg = regIsUSD ? 'US$ ' : '$ ';
          const montoReg = i.monto != null ? Number(i.monto) : null;
          const valReg = montoReg != null ? (simboloReg + formatearNumero(montoReg, monedaReg)) : '‚Äì';
          const difiereDeVista = (monedaReg !== (moneda || '').toString().trim().toUpperCase());
          const fecha = fechaStr(i.fecha);
          const tasa = (cacheTC[fecha] && cacheTC[fecha][tipoDolar] != null && cacheTC[fecha][tipoDolar] > 0) ? cacheTC[fecha][tipoDolar] : getTasaAnterior(fecha, tipoDolar);
          const valVista = !difiereDeVista
            ? '<span class="muted">‚Äî</span>'
            : (i.montoConvertido != null
              ? (simbolo + formatearNumero(i.montoConvertido, moneda))
              : '<span class="muted">sin cot.</span>');
          const valTC = !difiereDeVista
            ? '<span class="muted">‚Äî</span>'
            : (tasa != null
              ? `<span class="muted">${esc(fmtTC(Number(tasa)))}</span>`
              : '<span class="muted">sin cot.</span>');
          const desc = (i.descripcion || i.cliente || '‚Äì').slice(0, 120);
          const origen = (i.origen_archivo || '').trim();
          return `
            <tr>
              <td>${esc(fechaStr(i.fecha))}</td>
              <td>${esc(i.tipo_movimiento || '')}</td>
              <td>${esc(i.medio_pago || '')}</td>
              <td>${esc(monedaReg)}</td>
              <td class="monto-reg">${esc(valReg)}</td>
              <td class="monto-vista">${valVista}</td>
              <td>${valTC}</td>
              <td class="desc">${esc(desc)}</td>
              <td>${origen ? `<span class="origen-detalle" title="Origen">${esc(origen)}</span>` : '<span class="muted">‚Äî</span>'}</td>
            </tr>
          `;
        }).join('');
        const foot = '</tbody></table>';
        return head + body + foot;
      };

      const porCategoria = {};
      const erroresClasificacion = [];
      transaccionesMes.forEach(r => {
        const infoCat = getCategoriaDisplayConValidacion(r);
        const catDisplay = infoCat.categoria || 'Sin categor√≠a';
        if (!porCategoria[catDisplay]) porCategoria[catDisplay] = [];
        porCategoria[catDisplay].push({ ...r, montoConvertido: montoConvertido(r, moneda, tipoDolar) });
        if (infoCat.esError && r.tipo_movimiento === 'Egreso') {
          erroresClasificacion.push({
            ...r,
            categoriaDisplay: catDisplay,
            categoriaOriginal: (r.categoria || '').trim() || 'Sin categor√≠a'
          });
        }
      });
      const itemsIngreso = cat => (porCategoria[cat] || []).filter(i => i.tipo_movimiento === 'Ingreso');
      const itemsEgreso = cat => (porCategoria[cat] || []).filter(i => i.tipo_movimiento === 'Egreso');
      const categoriasIngreso = Object.keys(porCategoria).filter(cat => itemsIngreso(cat).length > 0).sort();
      const categoriasEgreso = Object.keys(porCategoria).filter(cat => itemsEgreso(cat).length > 0).sort();
      const filasModal = [
        ...categoriasIngreso.map(cat => ({ nombre: cat, items: itemsIngreso(cat), totalCat: totalSolo(itemsIngreso(cat)), esIngreso: true })),
        ...categoriasEgreso.map(cat => ({ nombre: cat, items: itemsEgreso(cat), totalCat: totalSolo(itemsEgreso(cat)), esIngreso: false }))
      ];

      const porCuenta = {};
      transaccionesMes.forEach(r => {
        const cuenta = (r.cuenta_contable || '').trim() || 'Sin cuenta contable';
        if (!porCuenta[cuenta]) porCuenta[cuenta] = [];
        porCuenta[cuenta].push({ ...r, montoConvertido: montoConvertido(r, moneda, tipoDolar) });
      });
      const itemsIngresoCuenta = cuenta => (porCuenta[cuenta] || []).filter(i => i.tipo_movimiento === 'Ingreso');
      const itemsEgresoCuenta = cuenta => (porCuenta[cuenta] || []).filter(i => i.tipo_movimiento === 'Egreso');
      const cuentasIngreso = Object.keys(porCuenta).filter(c => itemsIngresoCuenta(c).length > 0).sort();
      const cuentasEgreso = Object.keys(porCuenta).filter(c => itemsEgresoCuenta(c).length > 0).sort();
      const filasModalCuenta = [
        ...cuentasIngreso.map(cuenta => ({ nombre: cuenta, items: itemsIngresoCuenta(cuenta), totalCat: totalSolo(itemsIngresoCuenta(cuenta)), esIngreso: true })),
        ...cuentasEgreso.map(cuenta => ({ nombre: cuenta, items: itemsEgresoCuenta(cuenta), totalCat: totalSolo(itemsEgresoCuenta(cuenta)), esIngreso: false }))
      ];

      document.getElementById('modal-titulo').textContent = labelMes;
      const body = document.getElementById('modal-body');

      const buildTabla = (filas, prefixId, columnaNombre, tipo, anioSel, mesSel) => {
        let h = `<table class="modal-tabla"><thead><tr><th>Mes</th><th>${columnaNombre}</th><th>Monto</th><th></th></tr></thead><tbody>`;
        filas.forEach((fila, idx) => {
          const { nombre, items, totalCat, esIngreso } = fila;
          const claseMonto = esIngreso ? 'ingresos' : 'egresos';
          const detalleTabla = renderDetalleTabla(items);
          const nombreEsc = nombre.replace(/</g,'&lt;').replace(/"/g,'&quot;');
          const nombreAttr = nombre.replace(/"/g, '&quot;');
          h += `
          <tr data-row-index="${idx}">
            <td>${labelMes.replace(/</g,'&lt;')}</td>
            <td>${nombreEsc}</td>
            <td class="${claseMonto}">${simbolo}${formatearNumero(totalCat, moneda)}</td>
            <td><button type="button" class="ver-btn icon-btn" data-row-index="${idx}" data-prefix="${prefixId}" aria-label="Ver transacciones" title="Ver transacciones"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button><button type="button" class="grafico-btn icon-btn" data-tipo="${tipo}" data-nombre="${nombreAttr}" data-anio="${anioSel}" data-mes="${mesSel}" aria-label="Ver gr√°fico" title="Ver gr√°fico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></button></td>
          </tr>
          <tr class="detalle-cat" id="${prefixId}-detalle-${idx}" style="display:none;">
            <td colspan="4">${detalleTabla}</td>
          </tr>`;
        });
        h += '</tbody></table>';
        return h;
      };

      const erroresCount = erroresClasificacion.length;
      const erroresResumenHtml = erroresCount === 0
        ? '<p class="muted">No hay registros con errores de clasificaci√≥n en este mes.</p>'
        : `
          <p><strong>Tipo de Error:</strong> Inconsistencia entre Categoria , Cuenta Contable y Descripcion</p>
          <p><strong>Cantidad de registros con este error:</strong> ${erroresCount}</p>
          <button type="button" class="btn-ver-errores" data-anio="${anio}" data-mes="${mes}">Ver detalle de errores</button>
        `;

      let html = `
        <div class="modal-tabs" role="tablist">
          <button type="button" class="modal-tab activo" data-panel="categoria" role="tab">By Categoria</button>
          <button type="button" class="modal-tab" data-panel="cuenta" role="tab">By Cuenta Contable</button>
          <button type="button" class="modal-tab" data-panel="errores" role="tab">Errores (${erroresCount})</button>
        </div>
        <div id="modal-panel-categoria" class="modal-panel activo">${buildTabla(filasModal, 'modal-detalle-cat', 'Categor√≠a', 'categoria', anio, mes)}</div>
        <div id="modal-panel-cuenta" class="modal-panel">${buildTabla(filasModalCuenta, 'modal-detalle-cuenta', 'Cuenta contable', 'cuenta', anio, mes)}</div>
        <div id="modal-panel-errores" class="modal-panel">${erroresResumenHtml}</div>
      `;
      body.innerHTML = html;

      body.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const panelId = tab.getAttribute('data-panel');
          body.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('activo'));
          body.querySelectorAll('.modal-panel').forEach(p => p.classList.remove('activo'));
          tab.classList.add('activo');
          const panel = document.getElementById('modal-panel-' + panelId);
          if (panel) panel.classList.add('activo');
        });
      });

      body.querySelectorAll('.ver-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = btn.getAttribute('data-row-index');
          const prefix = btn.getAttribute('data-prefix');
          const detalle = document.getElementById(prefix + '-detalle-' + idx);
          if (detalle) {
            const visible = detalle.style.display !== 'none';
            detalle.style.display = visible ? 'none' : 'table-row';
            btn.setAttribute('title', visible ? 'Ver transacciones' : 'Ocultar');
            btn.setAttribute('aria-label', visible ? 'Ver transacciones' : 'Ocultar');
          }
        });
      });
      body.querySelectorAll('.grafico-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const anioSel = btn.getAttribute('data-anio');
          const mesSel = btn.getAttribute('data-mes');
          openGraficoModal(btn.getAttribute('data-tipo'), btn.getAttribute('data-nombre'), anioSel ? parseInt(anioSel, 10) : null, mesSel ? parseInt(mesSel, 10) : null);
        });
      });

      const btnVerErrores = body.querySelector('.btn-ver-errores');
      if (btnVerErrores && erroresClasificacion.length > 0) {
        btnVerErrores.addEventListener('click', (e) => {
          e.stopPropagation();
          abrirModalErrores(labelMes, erroresClasificacion, anio, mes);
        });
      }

      document.getElementById('modal-backdrop').classList.remove('oculto');
    }

    function getErroresDelMes(anio, mes) {
      const transaccionesMes = cacheTransacciones.filter(r => r.anio === anio && r.mes === mes && !excluirCategoria(r.categoria));
      const erroresClasificacion = [];
      transaccionesMes.forEach(r => {
        const infoCat = getCategoriaDisplayConValidacion(r);
        if (infoCat.esError && r.tipo_movimiento === 'Egreso') {
          erroresClasificacion.push({
            ...r,
            tipoError: TIPO_ERROR_INCONSISTENCIA,
            categoriaDisplay: infoCat.categoria || 'Sin categor√≠a',
            categoriaOriginal: (r.categoria || '').trim() || 'Sin categor√≠a'
          });
        }
      });
      const duplicadosMes = getErroresDuplicados().filter(e => e.anio === anio && e.mes === mes);
      duplicadosMes.forEach(d => {
        d.categoriaDisplay = getCategoriaDisplay(d.categoria, d.descripcion, d.cat_desc) || 'Sin categor√≠a';
        d.categoriaOriginal = (d.categoria || '').trim() || 'Sin categor√≠a';
      });
      return [...erroresClasificacion, ...duplicadosMes];
    }

    function getErroresGlobal() {
      const erroresClasificacion = [];
      cacheTransacciones.filter(r => !excluirCategoria(r.categoria)).forEach(r => {
        const infoCat = getCategoriaDisplayConValidacion(r);
        if (infoCat.esError && r.tipo_movimiento === 'Egreso') {
          erroresClasificacion.push({
            ...r,
            tipoError: TIPO_ERROR_INCONSISTENCIA,
            categoriaDisplay: infoCat.categoria || 'Sin categor√≠a',
            categoriaOriginal: (r.categoria || '').trim() || 'Sin categor√≠a'
          });
        }
      });
      const duplicados = getErroresDuplicados();
      duplicados.forEach(d => {
        d.categoriaDisplay = getCategoriaDisplay(d.categoria, d.descripcion, d.cat_desc) || 'Sin categor√≠a';
        d.categoriaOriginal = (d.categoria || '').trim() || 'Sin categor√≠a';
      });
      return [...erroresClasificacion, ...duplicados];
    }

    function getFiltroTipoError() {
      const sel = document.getElementById('filtro-tipo-error');
      return (sel && sel.value) ? sel.value : 'todos';
    }

    function renderErroresGlobal() {
      const tbody = document.getElementById('tbody-errores-global');
      if (!tbody) return;
      const todos = getErroresGlobal();
      const filtro = getFiltroTipoError();
      const errores = filtro === 'todos' ? todos : todos.filter(r => {
        if (filtro === 'inconsistencia') return r.tipoError === TIPO_ERROR_INCONSISTENCIA;
        if (filtro === 'duplicado') return r.tipoError === TIPO_ERROR_DUPLICADO;
        return true;
      });
      lastErroresGlobal = errores;
      if (!errores.length) {
        const msg = filtro === 'todos' ? 'No hay registros con errores de clasificaci√≥n.' : 'No hay registros con el tipo de error seleccionado.';
        tbody.innerHTML = '<tr><td colspan="14" style="text-align:center; color:#666;">' + msg + '</td></tr>';
        return;
      }
      const esc = (v) => (v == null ? '' : String(v)).replace(/</g, '&lt;');
      const rows = errores.map(r => {
        const regIsUSD = esTransaccionUSD(r);
        const monedaReg = regIsUSD ? 'USD' : 'ARS';
        const simboloReg = regIsUSD ? 'US$ ' : '$ ';
        const montoReg = r.monto != null ? Number(r.monto) : null;
        const valReg = montoReg != null ? (simboloReg + formatearNumero(montoReg, monedaReg)) : '‚Äì';
        const id = (r.id || '').toString().replace(/"/g, '&quot;');
        const labelMes = (r.mes != null && r.anio != null) ? formatoMesAnio(r.mes, r.anio) : '';
        const esDuplicado = r.tipoError === TIPO_ERROR_DUPLICADO;
        const btnVer = esDuplicado ? `<button type="button" class="ver-duplicado-btn edit-btn edit-btn-global" data-id="${id}" title="Ver posible duplicado" aria-label="Ver posible duplicado"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>` : '';
        return `
          <tr>
            <td>${esc(r.tipoError || '')}</td>
            <td>${esc(fechaStr(r.fecha))}</td>
            <td>${esc(labelMes)}</td>
            <td>${esc(r.tipo_movimiento || '')}</td>
            <td>${esc(r.categoriaOriginal || '')}</td>
            <td>${esc(getCategoriaDisplay(r.categoria, r.descripcion, r.cat_desc) || '')}</td>
            <td>${esc(r.cuenta_contable || '')}</td>
            <td>${esc(r.medio_pago || '')}</td>
            <td>${esc(valReg)}</td>
            <td>${esc(monedaReg)}</td>
            <td>${esc((r.descripcion || r.cliente || '‚Äì').slice(0, 160))}</td>
            <td>${esc((r.origen_archivo || '').trim() || '‚Äî')}</td>
            <td>${r.editado === true ? 'S√≠' : ''}</td>
            <td>${btnVer}<button type="button" class="edit-btn edit-btn-global" data-id="${id}" title="Editar registro" aria-label="Editar registro"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button></td>
          </tr>
        `;
      }).join('');
      tbody.innerHTML = rows;
      currentErroresList = errores;
      currentErroresLabel = 'Todos los meses';
      currentErroresAnio = null;
      currentErroresMes = null;
      tbody.querySelectorAll('.edit-btn-global').forEach(btn => {
        if (btn.classList.contains('ver-duplicado-btn')) return;
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.getAttribute('data-id');
          const record = currentErroresList.find(x => (x.id || '').toString() === id);
          if (record) abrirModalEditar(record);
        });
      });
      tbody.querySelectorAll('.ver-duplicado-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const id = btn.getAttribute('data-id');
          const record = currentErroresList.find(x => (x.id || '').toString() === id);
          if (record && record.tipoError === TIPO_ERROR_DUPLICADO && record.registroPosibleDuplicado) abrirModalDuplicado(record);
        });
      });
    }

    let currentErroresList = [];
    let currentErroresLabel = '';
    let currentErroresAnio = null;
    let currentErroresMes = null;

    function abrirModalErrores(labelMes, errores, anio, mes) {
      const backdrop = document.getElementById('modal-errores-backdrop');
      const body = document.getElementById('modal-errores-body');
      const titulo = document.getElementById('modal-errores-titulo');
      if (!backdrop || !body || !titulo) return;
      currentErroresList = errores || [];
      currentErroresLabel = labelMes || '';
      currentErroresAnio = anio != null ? anio : null;
      currentErroresMes = mes != null ? mes : null;
      titulo.textContent = 'Errores ‚Äî ' + (labelMes || '');
      if (!errores || errores.length === 0) {
        body.innerHTML = '<p class="muted">No hay registros con errores de clasificaci√≥n para este mes.</p>';
      } else {
        const esc = (v) => (v == null ? '' : String(v)).replace(/</g, '&lt;');
        const rows = errores.map(r => {
          const id = (r.id || '').toString().replace(/"/g, '&quot;');
          const esDup = r.tipoError === TIPO_ERROR_DUPLICADO;
          const btnVer = esDup ? `<button type="button" class="ver-duplicado-btn-modal edit-btn" data-id="${id}" title="Ver posible duplicado" aria-label="Ver posible duplicado"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>` : '';
          return `
          <tr>
            <td>${esc(r.tipoError || '')}</td>
            <td>${esc(fechaStr(r.fecha))}</td>
            <td>${esc(r.tipo_movimiento || '')}</td>
            <td>${esc(r.categoriaOriginal || '')}</td>
            <td>${esc(r.categoriaDisplay || '')}</td>
            <td>${esc(r.cuenta_contable || '')}</td>
            <td>${esc(r.medio_pago || '')}</td>
            <td>${esc((r.descripcion || r.cliente || '‚Äì').slice(0, 160))}</td>
            <td>${esc((r.origen_archivo || '').trim() || '‚Äî')}</td>
            <td>${btnVer}<button type="button" class="edit-btn" data-id="${id}" title="Editar registro" aria-label="Editar registro"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button></td>
          </tr>
        `;
        }).join('');
        body.innerHTML = `
          <table class="detalle-tabla">
            <thead>
              <tr>
                <th>Tipo de error</th>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Categor√≠a orig.</th>
                <th>Categor√≠a mostrada</th>
                <th>Cuenta contable</th>
                <th>Medio</th>
                <th>Descripci√≥n</th>
                <th>Origen</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        `;
        body.querySelectorAll('.edit-btn').forEach(btn => {
          if (btn.classList.contains('ver-duplicado-btn-modal')) {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const id = btn.getAttribute('data-id');
              const record = currentErroresList.find(x => (x.id || '').toString() === id);
              if (record && record.tipoError === TIPO_ERROR_DUPLICADO && record.registroPosibleDuplicado) abrirModalDuplicado(record);
            });
            return;
          }
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const id = btn.getAttribute('data-id');
            const record = currentErroresList.find(x => (x.id || '').toString() === id);
            if (record) abrirModalEditar(record);
          });
        });
      }
      backdrop.classList.remove('oculto');
    }

    function abrirModalEditar(record) {
      const backdrop = document.getElementById('modal-editar-backdrop');
      const titulo = document.getElementById('modal-editar-titulo');
      const editFecha = document.getElementById('edit-fecha');
      const editCategoria = document.getElementById('edit-categoria');
      const editCuenta = document.getElementById('edit-cuenta-contable');
      const editDescripcion = document.getElementById('edit-descripcion');
      if (!backdrop || !editCategoria || !editCuenta || !editDescripcion) return;
      titulo.textContent = 'Editar registro ‚Äî ' + (fechaStr(record.fecha) || '');
      editFecha.value = fechaStr(record.fecha) || '';
      editDescripcion.value = (record.descripcion || '').toString();

      const categoriasUnicas = [...new Set(cacheTransacciones.map(r => (r.categoria || '').trim()).filter(Boolean))].sort();
      const cuentasUnicas = [...new Set(cacheTransacciones.map(r => (r.cuenta_contable || '').trim()).filter(Boolean))].sort();
      editCategoria.innerHTML = '<option value="">‚Äî</option>' + categoriasUnicas.map(c => '<option value="' + (c.replace(/"/g, '&quot;')) + '">' + (c.replace(/</g, '&lt;')) + '</option>').join('');
      editCuenta.innerHTML = '<option value="">‚Äî</option>' + cuentasUnicas.map(c => '<option value="' + (c.replace(/"/g, '&quot;')) + '">' + (c.replace(/</g, '&lt;')) + '</option>').join('');
      editCategoria.value = (record.categoria || '').trim();
      editCuenta.value = (record.cuenta_contable || '').trim();

      const guardarBtn = document.getElementById('edit-guardar');
      const cancelarBtn = document.getElementById('edit-cancelar');
      const oneGuardar = async () => {
        const nuevaCat = (editCategoria.value || '').trim();
        const nuevaCuenta = (editCuenta.value || '').trim();
        const nuevaDesc = (editDescripcion.value || '').trim();
        const partes = [];
        if (nuevaCat !== (record.categoria || '').trim()) partes.push('Categoria');
        if (nuevaDesc !== (record.descripcion || '').toString().trim()) partes.push('Descripcion');
        if (nuevaCuenta !== (record.cuenta_contable || '').trim()) partes.push('Cuenta Contable');
        if (partes.length === 0) {
          document.getElementById('modal-editar-backdrop').classList.add('oculto');
          return;
        }
        const editadoDetalle = partes.join(', ');
        const payload = { categoria: nuevaCat || null, cuenta_contable: nuevaCuenta || null, descripcion: nuevaDesc || null, editado: true, editado_detalle: editadoDetalle };
        const { error } = await client.from('transacciones').update(payload).eq('id', record.id);
        if (error) { alert('Error al guardar: ' + (error.message || 'Unknown')); return; }
        document.getElementById('modal-editar-backdrop').classList.add('oculto');
        await cargarDatos();
        recalcular();
        renderErroresGlobal();
        if (currentErroresAnio != null && currentErroresMes != null) {
          const nuevosErrores = getErroresDelMes(currentErroresAnio, currentErroresMes);
          abrirModalErrores(currentErroresLabel, nuevosErrores, currentErroresAnio, currentErroresMes);
        }
      };
      guardarBtn.replaceWith(guardarBtn.cloneNode(true));
      cancelarBtn.replaceWith(cancelarBtn.cloneNode(true));
      document.getElementById('edit-guardar').addEventListener('click', oneGuardar);
      document.getElementById('edit-cancelar').addEventListener('click', () => document.getElementById('modal-editar-backdrop').classList.add('oculto'));
      backdrop.classList.remove('oculto');
    }

    let currentDuplicadoRecord = null;

    function renderRegistroEnModal(reg) {
      const esc = (v) => (v == null ? '' : String(v)).replace(/</g, '&lt;');
      const moneda = esTransaccionUSD(reg) ? 'USD' : 'ARS';
      const sim = esTransaccionUSD(reg) ? 'US$ ' : '$ ';
      const monto = reg.monto != null ? sim + formatearNumero(Number(reg.monto), moneda) : '‚Äì';
      return `
        <dl>
          <dt>id_origen</dt><dd>${esc(reg.id_origen)}</dd>
          <dt>Fecha</dt><dd>${esc(fechaStr(reg.fecha))}</dd>
          <dt>Tipo</dt><dd>${esc(reg.tipo_movimiento)}</dd>
          <dt>Monto</dt><dd>${esc(monto)}</dd>
          <dt>Cliente</dt><dd>${esc(reg.cliente || '‚Äî')}</dd>
          <dt>Medio de pago</dt><dd>${esc(reg.medio_pago)}</dd>
          <dt>Categor√≠a</dt><dd>${esc(reg.categoria)}</dd>
          <dt>Cuenta contable</dt><dd>${esc(reg.cuenta_contable)}</dd>
          <dt>Descripci√≥n</dt><dd>${esc((reg.descripcion || reg.cliente || '‚Äì').slice(0, 200))}</dd>
          <dt>Origen</dt><dd>${esc(reg.origen_archivo || '‚Äî')}</dd>
        </dl>
      `;
    }

    function abrirModalDuplicado(record) {
      const backdrop = document.getElementById('modal-duplicado-backdrop');
      const bodyEste = document.getElementById('modal-duplicado-este');
      const bodyOtro = document.getElementById('modal-duplicado-otro');
      if (!backdrop || !bodyEste || !bodyOtro) return;
      currentDuplicadoRecord = record;
      const otro = record.registroPosibleDuplicado;
      bodyEste.innerHTML = renderRegistroEnModal(record);
      bodyOtro.innerHTML = otro ? renderRegistroEnModal(otro) : '<p class="muted">‚Äî</p>';

      const btnCerrar = document.getElementById('modal-duplicado-close');
      const btnExcluir = document.getElementById('modal-duplicado-excluir');
      const btnEliminar = document.getElementById('modal-duplicado-eliminar');
      const btnCerrarAbajo = document.getElementById('modal-duplicado-cerrar');

      const cerrar = () => { backdrop.classList.add('oculto'); currentDuplicadoRecord = null; };

      const oneExcluir = async () => {
        if (!currentDuplicadoRecord || !currentDuplicadoRecord.id) return;
        if (!confirm('¬øExcluir este registro de todos los c√°lculos (marcar como anulado)? No se borrar√°, pero dejar√° de sumar en el flujo.')) return;
        const { error } = await client.from('transacciones').update({ status: 'Anulado' }).eq('id', currentDuplicadoRecord.id);
        if (error) { alert('Error al anular: ' + (error.message || 'Unknown')); return; }
        cerrar();
        await cargarDatos();
        recalcular();
        renderErroresGlobal();
      };
      const oneEliminar = async () => {
        if (!currentDuplicadoRecord || !currentDuplicadoRecord.id) return;
        if (!confirm('¬øEliminar este registro de la base de datos? Esta acci√≥n no se puede deshacer.')) return;
        const { error } = await client.from('transacciones').delete().eq('id', currentDuplicadoRecord.id);
        if (error) { alert('Error al eliminar: ' + (error.message || 'Unknown')); return; }
        cerrar();
        await cargarDatos();
        recalcular();
        renderErroresGlobal();
      };

      btnCerrar.onclick = cerrar;
      btnCerrarAbajo.onclick = cerrar;
      btnExcluir.onclick = oneExcluir;
      btnEliminar.onclick = oneEliminar;

      backdrop.classList.remove('oculto');
    }

    async function init() {
      const loading = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const filtrosWrap = document.getElementById('filtros-wrap');
      const tablaWrap = document.getElementById('tabla-wrap');
      const labelTipoDolar = document.getElementById('label-tipo-dolar');

      try {
        if (!loading || !errorEl) return;
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        if (sidebar && sidebarToggle) {
          const saved = localStorage.getItem('fornitalia-sidebar-expanded');
          if (saved === '1') sidebar.classList.add('expanded');
          sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('expanded');
            localStorage.setItem('fornitalia-sidebar-expanded', sidebar.classList.contains('expanded') ? '1' : '0');
            sidebarToggle.setAttribute('aria-label', sidebar.classList.contains('expanded') ? 'Contraer men√∫' : 'Expandir men√∫');
          });
          sidebarToggle.setAttribute('aria-label', sidebar.classList.contains('expanded') ? 'Contraer men√∫' : 'Expandir men√∫');
        }
        document.getElementById('menu-home')?.addEventListener('click', (e) => { e.preventDefault(); });

        await cargarDatos();
        filtrosWrap.style.display = 'flex';
        tablaWrap.style.display = 'block';
        loading.style.display = 'none';

        document.querySelectorAll('#toggle-moneda button').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('#toggle-moneda button').forEach(b => b.classList.remove('activo'));
            btn.classList.add('activo');
            labelTipoDolar.style.display = getMoneda() === 'USD' ? 'flex' : 'none';
            recalcular();
          });
        });
        document.getElementById('tipoDolar').addEventListener('change', recalcular);
        document.getElementById('btn-exportar-excel').addEventListener('click', exportarAExcel);
        document.getElementById('btn-exportar-errores').addEventListener('click', exportarErroresExcel);
        document.getElementById('filtro-tipo-error').addEventListener('change', renderErroresGlobal);
        labelTipoDolar.style.display = getMoneda() === 'USD' ? 'flex' : 'none';
        recalcular();

        document.getElementById('tbody').addEventListener('click', (e) => {
          const iconAlert = e.target.closest('.alert-icon');
          if (iconAlert) {
            e.stopPropagation();
            const alertas = JSON.parse(iconAlert.getAttribute('data-alertas') || '[]');
            const label = iconAlert.getAttribute('data-label') || '';
            document.getElementById('modal-alertas-titulo').textContent = 'Alertas ‚Äî ' + label;
            document.getElementById('modal-alertas-body').innerHTML = alertas.length
              ? '<ul>' + alertas.map(a => '<li>' + (a.replace(/</g, '&lt;')) + '</li>').join('') + '</ul>'
              : '<p>No hay alertas.</p>';
            document.getElementById('modal-alertas-backdrop').classList.remove('oculto');
            return;
          }
          const tr = e.target.closest('tr.fila-mes');
          if (tr) abrirModal(parseInt(tr.dataset.anio, 10), parseInt(tr.dataset.mes, 10));
        });

        document.getElementById('modal-close').addEventListener('click', () => document.getElementById('modal-backdrop').classList.add('oculto'));
        document.getElementById('modal-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-backdrop') e.target.classList.add('oculto'); });
        document.getElementById('modal-alertas-close').addEventListener('click', () => document.getElementById('modal-alertas-backdrop').classList.add('oculto'));
        document.getElementById('modal-alertas-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-alertas-backdrop') e.target.classList.add('oculto'); });
        document.getElementById('modal-grafico-close').addEventListener('click', () => {
          document.getElementById('modal-grafico-backdrop').classList.add('oculto');
          if (chartSerieMensual) { chartSerieMensual.destroy(); chartSerieMensual = null; }
        });
        document.getElementById('modal-grafico-backdrop').addEventListener('click', (e) => {
          if (e.target.id === 'modal-grafico-backdrop') {
            e.target.classList.add('oculto');
            if (chartSerieMensual) { chartSerieMensual.destroy(); chartSerieMensual = null; }
          }
        });
        document.getElementById('modal-errores-close').addEventListener('click', () => document.getElementById('modal-errores-backdrop').classList.add('oculto'));
        document.getElementById('modal-errores-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-errores-backdrop') e.target.classList.add('oculto'); });
        document.getElementById('modal-editar-close').addEventListener('click', () => document.getElementById('modal-editar-backdrop').classList.add('oculto'));
        document.getElementById('modal-editar-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-editar-backdrop') e.target.classList.add('oculto'); });

        function setupModalDrag(modalId, headerId, closeBtnId) {
          const modal = document.getElementById(modalId);
          const header = document.getElementById(headerId);
          const closeBtn = document.getElementById(closeBtnId);
          if (!modal || !header) return;
          header.addEventListener('mousedown', function(e) {
            if (e.target === closeBtn || closeBtn.contains(e.target)) return;
            const rect = modal.getBoundingClientRect();
            let startX = e.clientX - rect.left;
            let startY = e.clientY - rect.top;
            modal.style.position = 'fixed';
            modal.style.left = rect.left + 'px';
            modal.style.top = rect.top + 'px';
            modal.style.right = 'auto';
            modal.style.transform = 'none';
            function move(e) {
              modal.style.left = (e.clientX - startX) + 'px';
              modal.style.top = (e.clientY - startY) + 'px';
            }
            function stop() {
              document.removeEventListener('mousemove', move);
              document.removeEventListener('mouseup', stop);
            }
            document.addEventListener('mousemove', move);
            document.addEventListener('mouseup', stop);
          });
        }
        setupModalDrag('modal-caja', 'modal-header-drag', 'modal-close');
        setupModalDrag('modal-alertas', 'modal-alertas-header-drag', 'modal-alertas-close');
        setupModalDrag('modal-grafico', 'modal-grafico-header-drag', 'modal-grafico-close');
        setupModalDrag('modal-errores', 'modal-errores-header-drag', 'modal-errores-close');
        setupModalDrag('modal-editar-registro', 'modal-editar-header-drag', 'modal-editar-close');

        document.querySelectorAll('.tab').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('activo'));
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('activo'));
            btn.classList.add('activo');
            const id = btn.getAttribute('data-panel');
            if (id) document.getElementById('panel-' + id).classList.add('activo');
            if (id === 'evolucion') renderEvolucion();
          });
        });
        document.getElementById('evolucion-agrupar').addEventListener('change', renderEvolucion);
        document.getElementById('evolucion-periodo').addEventListener('change', renderEvolucion);
        document.getElementById('btn-exportar-evolucion').addEventListener('click', exportarEvolucionExcel);
        document.getElementById('modal-evolucion-detalle-close').addEventListener('click', () => document.getElementById('modal-evolucion-detalle-backdrop').classList.add('oculto'));
        document.getElementById('modal-evolucion-detalle-backdrop').addEventListener('click', (e) => { if (e.target.id === 'modal-evolucion-detalle-backdrop') e.target.classList.add('oculto'); });
      } catch (e) {
        errorEl.textContent = 'Error: ' + (e.message || String(e));
        errorEl.style.display = 'block';
      } finally {
        if (loading) loading.style.display = 'none';
      }
    }

    init();
  </script>
</body>
</html>
